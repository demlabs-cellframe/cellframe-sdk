{
  "phase": "5.4 - OBJECT Library Migration",
  "status": "BLOCKED_BY_CYCLES",
  "date": "2025-12-16T16:15:00Z",
  
  "discovered_cycles": {
    "cycle_1_blocks_esbocs": {
      "modules": ["blocks", "esbocs"],
      "direction": "bidirectional",
      "blocks_uses_esbocs": {
        "file": "modules/type/blocks/dap_chain_type_blocks.c:41",
        "include": "#include \"dap_chain_cs_esbocs.h\"",
        "usage": "dap_chain_esbocs_block_collect_t structure",
        "count": 1
      },
      "esbocs_uses_blocks": {
        "file": "modules/consensus/esbocs/dap_chain_cs_esbocs.c:33",
        "include": "#include \"dap_chain_type_blocks.h\"",
        "usage": "dap_chain_block_* functions, DAP_CHAIN_TYPE_BLOCKS macro",
        "count": "70+"
      },
      "solution": "Type Extraction - move dap_chain_esbocs_block_collect_t to consensus/include/dap_chain_block_collect.h",
      "status": "PARTIALLY_IMPLEMENTED"
    },
    
    "cycle_2_wallet_net_esbocs_stake_compose": {
      "modules": ["wallet", "net", "esbocs", "stake", "compose"],
      "type": "5-module strongly connected component",
      
      "wallet_dependencies": {
        "real_code": ["net (for net_tx.h)"],
        "cmake_listed": ["net", "mempool"],
        "excessive": ["mempool - NOT used in code"]
      },
      
      "net_dependencies": {
        "real_code": ["esbocs (esbocs.h)", "stake (stake_pos_delegate.h)", "wallet (wallet.h, wallet_cache.h, wallet_shared.h)"],
        "cmake_listed": ["esbocs", "stake", "wallet", "mempool", "consensus"],
        "reason": "net is god module - knows about everything"
      },
      
      "esbocs_dependencies": {
        "real_code": ["stake (20+ function calls)", "blocks", "net", "mempool", "net_srv"],
        "cmake_listed": ["blocks", "net", "net_srv", "stake"],
        "reason": "esbocs implements PoS consensus - needs validator info from stake"
      },
      
      "stake_dependencies": {
        "real_code": ["esbocs (10 usages)", "wallet", "net", "net_srv"],
        "cmake_listed": ["compose", "net_srv"],
        "reason": "stake uses esbocs for consensus integration"
      },
      
      "compose_dependencies": {
        "real_code": ["wallet_shared.h", "net_srv (order.h)", "net_tx.h"],
        "cmake_listed": ["wallet"],
        "excessive": []
      },
      
      "cycle_paths": [
        "wallet → net → esbocs → stake → net (cycle)",
        "esbocs → stake → esbocs (bidirectional)",
        "net → wallet → net (bidirectional)",
        "compose → wallet → net → compose (indirect)"
      ],
      
      "solution_required": "Multi-stage architectural refactoring",
      "status": "ANALYZED"
    }
  },
  
  "architectural_problems": {
    "god_module_net": {
      "problem": "net module depends on almost everything (wallet, esbocs, stake, blocks)",
      "files": ["dap_chain_net.c", "dap_chain_net_balancer.c", "dap_chain_node.c"],
      "solution": "Split net into layers: core (networking) + services (wallet/stake integration)"
    },
    
    "tight_coupling_esbocs_stake": {
      "problem": "esbocs calls stake functions directly 20+ times",
      "solution": "Validator API abstraction - stake registers validator provider"
    },
    
    "wallet_in_net": {
      "problem": "net includes wallet headers (wallet.h, wallet_cache.h, wallet_shared.h)",
      "files": ["dap_chain_net.c", "dap_chain_node.c"],
      "solution": "Wallet operations should be in separate layer, not core net"
    }
  },
  
  "slc_compliant_solutions": {
    "phase_5_4_1": {
      "name": "Type Extraction - blocks ↔ esbocs",
      "action": "Move dap_chain_esbocs_block_collect_t to consensus/include/dap_chain_block_collect.h",
      "status": "PARTIALLY_DONE",
      "remaining": "Remove duplicate definitions, verify compilation"
    },
    
    "phase_5_4_2": {
      "name": "Validator API - esbocs → stake",
      "action": "Create dap_chain_validator_api.h in consensus module with callback registry",
      "methods": [
        "get_validators(net_id) → list",
        "check_key_delegated(addr) → bool",
        "mark_active(addr, state) → void",
        "get_pkey_by_hash(hash) → pkey*",
        "key_delegate(...) → int",
        "get_min_value(net_id) → uint256_t"
      ],
      "implementation": "stake registers implementation at init(), esbocs calls through API",
      "status": "NOT_STARTED"
    },
    
    "phase_5_4_3": {
      "name": "Net module decomposition",
      "action": "Split net into dap_chain_net_core (networking) + dap_chain_net_services (wallet/stake integration)",
      "files_to_move": ["wallet integration code", "stake integration code"],
      "new_module": "net-services (higher layer)",
      "status": "NOT_STARTED"
    },
    
    "phase_5_4_4": {
      "name": "Remove wallet from net core",
      "action": "Move wallet operations to net-services layer or use wallet API",
      "status": "NOT_STARTED"
    }
  },
  
  "immediate_action": "Implement Phase 5.4.2 (Validator API) to break esbocs ↔ stake cycle",
  
  "estimated_time": {
    "phase_5_4_1": "1 hour",
    "phase_5_4_2": "3-4 hours",
    "phase_5_4_3": "6-8 hours",
    "phase_5_4_4": "2-3 hours",
    "total": "12-16 hours"
  }
}

